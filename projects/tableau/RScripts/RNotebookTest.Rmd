---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

```{r}

library(RODBC) 
channel <- odbcDriverConnect('driver={SQL Server}; server=localhost\\MSSQLSERVER,1433; database=Weather; trusted_connection=true')

queryTest <- paste0("SELECT top 100 * FROM NOAARawData")

sqlQuery(channel, queryTest)

```





```{r}
#-----------------------------------------------------
#---------Data Import and Transformation--------------
#-----------------------------------------------------

# Import data in longform
rawData <-read.csv("/Sara/SaraGitHub/skammlade.github.io/projects/tableau/datafiles/QuickCropDataAvgValueByDecade.csv", 
               stringsAsFactors = FALSE,
               strip.white = TRUE,
               na.strings = c("NA",""))
colnames(rawData)<-c("CountryName","ItemName", "ElementName", "Decade","AvgValueForDecade")
head(rawData)

# save Country as a factor in new column 'fCountry', as some of the statistical methods require factors
rawData<-within(rawData, 
            fCountry<-as.factor(CountryName))

# Calculate total value of (kcal, grams, etc.) across all crops for each country in each year
countryDecadeSums<-aggregate(rawData$AvgValueForDecade, 
                             by=list(rawData$CountryName, 
                                     rawData$Decade, 
                                     rawData$ElementName), 
                             FUN=sum,
                             na.rm=TRUE)

colnames(countryDecadeSums)<-c("CountryName","Decade","ElementName","CountryDecadeSumValue")
crops<-merge(rawData,countryDecadeSums)
head(crops)

#Grand total of calories in each year, all countries combined
globalSum<-aggregate(crops$AvgValueForDecade, 
                           by=list(crops$ElementName, 
                                   crops$Decade), 
                           FUN=sum,na.rm=TRUE)

colnames(globalSum)<-c("ElementName","Decade","GlobalSum")
crops<-merge(crops,
             globalSum,
             by=c("Decade","ElementName"))

head(crops)

#Calculate proportion total for each crop
crops$Proportion<-crops$AvgValueForDecade/crops$CountryDecadeSumValue

#Add presence-absence - NOTE THAT THIS ASSUMES NA's ARE 0's!
crops$pres.abs<-0
crops$pres.abs[crops$AvgValueForDecade>0]<-1
head(crops)

#-------------------------------------------------------
#--------- Change in species Composition----------------
#-------------------------------------------------------

#create data subsets by ElementName
cropsCalories<-subset(crops, ElementName=="Calories")
cropsFat<-subset(crops, ElementName=="Fat")
cropsProtein<-subset(crops, ElementName=="Protein")
cropsFoodWeight<-subset(crops, ElementName=="Food Weight")

head(cropsCalories)
  
#convert missing values to zeros
cropsCalories$AvgValueForDecade[is.na(cropsCalories$AvgValueForDecade)]<-0
cropsFat$AvgValueForDecade[is.na(cropsFat$AvgValueForDecade)]<-0
cropsProtein$AvgValueForDecade[is.na(cropsProtein$AvgValueForDecade)]<-0
cropsFoodWeight$AvgValueForDecade[is.na(cropsFoodWeight$AvgValueForDecade)]<-0

#pivot datatable
library(reshape2)
pivotCropsCalories<-dcast(cropsCalories, Decade+CountryName ~ ItemName ,value.var="AvgValueForDecade")
pivotCropsFat<-dcast(cropsFat, Decade+CountryName ~ ItemName ,value.var="AvgValueForDecade")
pivotCropsProtein<-dcast(cropsProtein, Decade+CountryName ~ ItemName ,value.var="AvgValueForDecade")
pivotCropsFoodWeight<-dcast(cropsFoodWeight, Decade+CountryName ~ ItemName ,value.var="AvgValueForDecade")

#remove country and decade columns
dataNMDSDecadesCropsCalories<-pivotCropsCalories[,3:56]
dataNMDSDecadesCropsFat<-pivotCropsFat[,3:56]
dataNMDSDecadesCropsProtein<-pivotCropsProtein[,3:56]
dataNMDSDecadesCropsFoodWeight<-pivotCropsFoodWeight[,3:56]

#open vegan library
#https://cran.r-project.org/web/packages/vegan/vegan.pdf
library(vegan)



```

